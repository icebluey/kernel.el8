#!/usr/bin/env bash
export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

yum makecache
yum install -y linux-firmware

set -e

_tmp_dir="$(mktemp -d)"
cd "${_tmp_dir}"

git clone 'git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git'
sleep 2
cd linux-firmware

rm -fr Makefile.old Makefile.new
cp -fr Makefile Makefile.new

printf '\x23\x20\x54\x68\x69\x73\x20\x66\x69\x6C\x65\x20\x69\x6D\x70\x6C\x65\x6D\x65\x6E\x74\x73\x20\x74\x68\x65\x20\x47\x4E\x4F\x4D\x45\x20\x42\x75\x69\x6C\x64\x20\x41\x50\x49\x3A\x0A\x23\x20\x68\x74\x74\x70\x3A\x2F\x2F\x70\x65\x6F\x70\x6C\x65\x2E\x67\x6E\x6F\x6D\x65\x2E\x6F\x72\x67\x2F\x7E\x77\x61\x6C\x74\x65\x72\x73\x2F\x64\x6F\x63\x73\x2F\x62\x75\x69\x6C\x64\x2D\x61\x70\x69\x2E\x74\x78\x74\x0A\x0A\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x20\x3D\x20\x2F\x6C\x69\x62\x2F\x66\x69\x72\x6D\x77\x61\x72\x65\x0A\x0A\x61\x6C\x6C\x3A\x0A\x0A\x63\x68\x65\x63\x6B\x3A\x0A\x09\x2E\x2F\x63\x68\x65\x63\x6B\x5F\x77\x68\x65\x6E\x63\x65\x2E\x70\x79\x0A\x0A\x69\x6E\x73\x74\x61\x6C\x6C\x3A\x0A\x09\x6D\x6B\x64\x69\x72\x20\x2D\x70\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x0A\x09\x63\x70\x20\x2D\x66\x72\x20\x2A\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x0A\x09\x72\x6D\x20\x2D\x72\x66\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x2F\x75\x73\x62\x64\x75\x78\x0A\x09\x72\x6D\x20\x2D\x72\x66\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x2F\x63\x6F\x70\x79\x2D\x66\x69\x72\x6D\x77\x61\x72\x65\x2E\x73\x68\x0A\x09\x72\x6D\x20\x2D\x72\x66\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x2F\x4D\x61\x6B\x65\x66\x69\x6C\x65\x2E\x6F\x6C\x64\x0A\x09\x72\x6D\x20\x2D\x72\x66\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x2F\x4D\x61\x6B\x65\x66\x69\x6C\x65\x2E\x6E\x65\x77\x0A\x09\x66\x69\x6E\x64\x20\x24\x28\x44\x45\x53\x54\x44\x49\x52\x29\x24\x28\x46\x49\x52\x4D\x57\x41\x52\x45\x44\x49\x52\x29\x20\x5C\x28\x20\x2D\x6E\x61\x6D\x65\x20\x27\x57\x48\x45\x4E\x43\x45\x27\x20\x2D\x6F\x72\x20\x2D\x6E\x61\x6D\x65\x20\x27\x4C\x49\x43\x45\x4E\x53\x45\x2E\x2A\x27\x20\x2D\x6F\x72\x20\x5C\x0A\x09\x09\x2D\x6E\x61\x6D\x65\x20\x27\x4C\x49\x43\x45\x4E\x43\x45\x2E\x2A\x27\x20\x5C\x29\x20\x2D\x65\x78\x65\x63\x20\x72\x6D\x20\x2D\x2D\x20\x7B\x7D\x20\x5C\x3B\x0A' | dd seek=$((0x0)) conv=notrunc bs=1 of=Makefile.old
chmod 644 Makefile.old

###############################################################################

rm -fr Makefile
sleep 2
cat Makefile.old > Makefile

make install
sleep 2
cd /tmp
rm -fr "${_tmp_dir}"
echo
echo ' Update Linux Firmware done'
echo
exit

